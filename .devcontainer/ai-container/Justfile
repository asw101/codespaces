# justfile for building and testing devcontainers locally

# Default recipe - show available commands
default:
    @just --list

# Build the ai-container devcontainer locally
build-ai-container tag="latest":
    #!/usr/bin/env bash
    echo "Building ai-container devcontainer..."
    if docker build \
        -t codespaces-ai:{{tag}} \
        -t ghcr.io/asw101/codespaces/ai:{{tag}} \
        .; then
        echo "âœ… Built ai-container as codespaces-ai:{{tag}}"
    else
        echo "âŒ Build failed for ai-container"
        exit 1
    fi

# Run the ai-container interactively for testing
test-ai-container tag="latest":
    #!/usr/bin/env bash
    echo "Starting ai-container for testing..."
    docker run -it --rm \
        -v $(pwd)/../..:/workspace \
        -w /workspace \
        --name test-ai-container \
        codespaces-ai:{{tag}} \
        bash

# Run the ai-container as a background service (like VS Code would)
run-ai-container tag="latest":
    #!/usr/bin/env bash
    echo "Starting ai-container in background..."
    docker run -d \
        -v $(pwd)/../..:/workspace \
        -w /workspace \
        -p 8080:8080 \
        --name ai-container-service \
        codespaces-ai:{{tag}} \
        tail -f /dev/null
    echo "âœ… ai-container running as 'ai-container-service'"
    echo "Use 'docker exec -it ai-container-service bash' to get a shell"

# Stop the background ai-container service
stop-ai-container:
    #!/usr/bin/env bash
    echo "Stopping ai-container service..."
    docker stop ai-container-service || true
    docker rm ai-container-service || true
    echo "âœ… ai-container service stopped"

# Build and test ai-container in one command
build-and-test-ai tag="latest":
    just build-ai-container {{tag}}
    just test-ai-container {{tag}}

# Clean up Docker images and containers
clean:
    #!/usr/bin/env bash
    echo "Cleaning up Docker resources..."
    docker stop ai-container-service 2>/dev/null || true
    docker rm ai-container-service 2>/dev/null || true
    docker rmi codespaces-ai:latest 2>/dev/null || true
    docker rmi ghcr.io/asw101/codespaces/ai:latest 2>/dev/null || true
    echo "âœ… Cleanup complete"

# Test specific tools inside the container
test-tools tag="latest":
    #!/usr/bin/env bash
    echo "Testing tools in ai-container..."
    docker run --rm codespaces-ai:{{tag}} bash -c "
        echo '=== Go version ==='
        go version
        echo
        echo '=== Rust version ==='
        rustc --version
        cargo --version
        echo
        echo '=== Node.js version ==='
        node --version
        npm --version
        echo
        echo '=== Azure CLI ==='
        az --version | head -1
        echo
        echo '=== GitHub CLI ==='
        gh --version
        echo
        echo '=== Wassette ==='
        wassette --version
        echo
        echo '=== NPM global packages ==='
        npm list -g --depth=0
    "

# GitHub Actions Commands
# =======================

# Trigger GitHub Action to build a devcontainer
gh-build container="ai-container" tag="latest":
    #!/usr/bin/env bash
    echo "ğŸš€ Triggering GitHub Action to build {{container}}..."
    if gh workflow run "Build Single DevContainer" \
        --field devcontainer_choice={{container}} \
        --field image_tag={{tag}}; then
        echo "âœ… GitHub Action triggered successfully"
        echo "ğŸ’¡ Use 'just gh-watch' to monitor progress"
        echo "ğŸ’¡ Use 'just gh-list' to see recent runs"
    else
        echo "âŒ Failed to trigger GitHub Action"
        exit 1
    fi

# List recent GitHub Action workflow runs
gh-list limit="10":
    #!/usr/bin/env bash
    echo "ğŸ“‹ Recent GitHub Action runs:"
    gh run list --workflow="build-single-devcontainer.yml" --limit {{limit}}

# Watch the latest GitHub Action workflow run
gh-watch:
    #!/usr/bin/env bash
    echo "ğŸ‘€ Watching latest GitHub Action run..."
    echo "Press Ctrl+C to stop watching"
    gh run watch

# Show logs for the latest GitHub Action run
gh-logs:
    #!/usr/bin/env bash
    echo "ğŸ“„ Showing logs for latest GitHub Action run..."
    gh run view --log

# Complete workflow: trigger build and watch
gh-build-and-watch container="ai-container" tag="latest":
    just gh-build {{container}} {{tag}}
    sleep 2
    just gh-watch
